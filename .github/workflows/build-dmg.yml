name: Build Test DMG

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-dmg:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create test script and symlink
        run: |
          mkdir dmg-contents
          echo '#!/bin/bash' > dmg-contents/test.xyz
          echo 'echo "hello"' >> dmg-contents/test.xyz
          chmod +x dmg-contents/test.xyz
          
          # Снимаем карантин с .xyz
          xattr -cr dmg-contents/test.xyz
          
          # Создаём symlink на Terminal
          ln -s /System/Applications/Utilities/Terminal.app dmg-contents/Terminal
      
      - name: Install create-dmg
        run: brew install create-dmg
      
      - name: Build DMG
        run: |
          create-dmg \
            --volname "TestScript" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "test.xyz" 175 190 \
            --hide-extension "test.xyz" \
            --icon "Terminal" 425 190 \
            "TestScript.dmg" \
            "dmg-contents/"
      
      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: test-dmg
          path: "*.dmg"
